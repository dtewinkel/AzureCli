name: $(date:yyyyMMdd)$(rev:.rr)

trigger:
  batch: true
  branches:
    include:
    - '*'

variables:

- template: global-variables.yml

stages:

- template: build-stage.yml

- template: publish-stage.yml
  parameters:
    Repository.Name: TwiaMyGetPsGallery
    Repository.FeedUrl: https://www.myget.org/F/twia-ps-dev/api/v2/package
    Repository.ApiKey: $(MyGet.ApiKey)

- template: publish-stage.yml
  parameters:
    Condition: and( succeeded(), or( eq(variables['Build.SourceBranch'], 'refs/heads/master'), in( variables['Build.Reason'], 'Manual', 'Schedule' ) ) )
    Repository.Name: PsGallery
    repository.FeedUrl: https://www.powershellgallery.com/api/v2/package
    Repository.ApiKey: $(PsGallery.ApiKey)

- template: tag-stage.yml
