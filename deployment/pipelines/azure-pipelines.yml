name: $(date:yyyyMMdd)$(rev:.rr)

trigger:
  batch: true
  branches:
    include:
    - '*'

variables:

- template: global-variables.yml

stages:

- template: build-stage.yml

- template: publish-stage.yml
  parameters:
    RepositoryName: TwiaMyGetPsGallery
    RepositoryFeedUrl: https://www.myget.org/F/twia-ps-dev/api/v2/package
    RepositoryApiKey: $(MyGet.ApiKey)

- template: publish-stage.yml
  parameters:
    Condition: and( succeeded(), or( eq(variables['Build.SourceBranch'], 'refs/heads/master'), in( variables['Build.Reason'], 'Manual', 'Schedule' ) ) )
    RepositoryName: PsGallery
    repositoryFeedUrl: https://www.powershellgallery.com/api/v2/package
    RepositoryApiKey: $(PsGallery.ApiKey)

- template: tag-stage.yml
